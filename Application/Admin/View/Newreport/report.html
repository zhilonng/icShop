<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no" />
<title>方案</title>
<style>
html, body {margin:0 auto;background-color:#3E4961;font-family:"Microsoft YaHei",Arial,sans-serif;font-size:14px;}
ul,li{margin:0;padding:0;list-style:none;}
ul{clear:both;}
li{padding:3px 5px;border:1px solid #ccc;color:#666;font-size:12px;float:left;border-radius:5px;margin:0 5px 8px 0;}
select{font-family:"Microsoft YaHei",Arial,sans-serif;}
.seltab{background-color:#fff;color:#333;cursor:pointer}
.unseltab{background-color:#69738C;color:#fff;cursor:pointer}

.selItem{background-color:#333;color:#fff;padding:2px 15px 3px 15px;font-size:14px;border-radius:100px;border:1px solid #333;float:right;margin-left:5px;cursor:pointer}
.unselItem{color:#ccc;padding:2px 15px 3px 15px;font-size:14px;border-radius:100px;border:1px solid #333;float:right;margin-left:5px;cursor:pointer}

.enter_btn{float:right;padding:5px 15px;border:1px solid #f24d4d;color:#fff;border-radius:5px;background-color:#f24d4d;margin-left:10px;}
.orderOK_btn{float:right;padding:5px 15px;color:#000;border-radius:5px;background-color:#ffe600;margin-left:10px;}
.normal_btn{float:right;padding:5px 15px;border:1px solid #999;color:#666;border-radius:5px;background-color:#fff;margin-left:10px;}
.save_btn{float:left;padding:5px 15px;border:1px solid #999;color:#fff;border-radius:5px;background-color:#04BE02;margin-left:10px;}
.hide_btn{display: none;}
.hide_div{display: none;}
.left_info{font-size:10px;margin:5px 10px 5px 0;padding:2px 10px;background-color:#fff;border-radius:5px;float:left;color:#333;}
.del_info{font-size:10px;margin:5px 0;padding:2px 10px;background-color:#ddd;border-radius:5px;float:right;color:#333;}
.order_info{font-size:10px;margin:5px 0 5px 0;padding:2px 0;border-radius:5px;float:right;color:#fff;}
.order_info2{font-size:10px;margin:5px 0 5px 0;padding:2px 0;border-radius:5px;float:right;}
.bl_info{float:left;color:#666;margin:0 10px;line-height:30px;}

.ptop_0{padding:0 10px 0;height:31px;background-color:#6699FF;color:#fff;border-radius:5px 5px 0 0;}
.ptop_10{padding:0 10px 0;height:31px;background-color:#f24d4d;color:#fff;border-radius:5px 5px 0 0;}
.ptop_11{padding:0 10px 0;height:31px;background-color:#f24d4d;color:#fff;border-radius:5px 5px 0 0;}
.ptop_12{padding:0 10px 0;height:31px;background-color:#ffe600;color:#333;border-radius:5px 5px 0 0;}
.ptop_13{padding:0 10px 0;height:31px;background-color:#04BE02;color:#fff;border-radius:5px 5px 0 0;}
.ptop_14{padding:0 10px 0;height:31px;background-color:#04BE02;color:#fff;border-radius:5px 5px 0 0;}

.add_btn{padding:10px;background-color:#69738C;color:#fff;border-radius:5px;text-align:center;font-size:16px;cursor:pointer}
.pc_name{padding:2px 10px;border:1px solid #eee;margin-left:20px;font-size:16px;color:#bbb;border-radius:5px;}
.policy_div em{font-size:18px;font-style:normal;}
.policy_div{font-size:14px;padding:10px;background-color:#fff;border-bottom:1px solid #eee;height:20px;}
.policy_div div{float:left;width:48%;}
.policy_div span{padding-left:20px;font-weight:800;}
.policy_div select{margin-top:-4px;padding:3px 5px;border:1px solid #ddd;width:150px;font-weight:800;}
.policy_div .selLeft{width:20%;float:left;font-size:16px;font-weight:normal;}
.policy_div	.selRight{width:80%;float:left;font-size:16px;font-weight:normal;}
.policy_div	.pdiv_left{border-right:1px solid #eee; margin-right:10px}
</style>
</head>
<body>
<a name="jiating"></a>
<div style="color:#333;margin:0 auto;">
  <div style="height:100%;width:100%;">
    <div style="float:left;width:20%;height:97%;background-color:#fff;position:fixed;border-radius:6px;border:1px solid #color:#fff;;margin:1%;">
      <div style="border-bottom:1px solid #3E4961;background-color:#69738C;border-radius:5px 5px 0 0;overflow:hidden;">
        <div style="height:auto;padding:10px 10px;color:#333;border-radius:5px 5px 0 0;font-size:14px;line-height:19px;">
          <div style="float:left;width:80px;height:80px;margin-right:8px;border:1px solid #ddd;background-color:#ddd;;border-radius:5px;"><img src="{$user.headimgurl}" alt="" width="80" height="80" ></div>
          <div>
            <div style="font-weight:800;font-size:16px;margin-bottom:5px;white-space:nowrap;text-overflow:ellipsis;color:#fff;">{$user.nickname}</div>
            <div style="color:#ddd;font-size:12px;">姓名：{$user.realname}</div>
            <div style="color:#ddd;font-size:12px;">城市：{$family.city_name}</div>
            <div style="color:#ddd;font-size:12px;">电话：{$user.mobile}</div>
          </div>
        </div>
      </div>
      <div style="border-bottom:1px solid #eee;padding:10px;font-size:14px;"> <span style="color:#999;margin-right:15px;">客户状态</span><span style="font-weight:800;color:#f24d4d;">{$family.status|getFamilyStatus}</span> </div>
      <div style="border-bottom:1px solid #ddd;padding:12px 10px 4px;background-color:#fff;font-size:14px;overflow:hidden;">
        <ul>
        	<if condition="$family.birthday eq 1"> 
          <li>即将生日</li>
          </if>
          <if condition="$family.report_day egt 7"> 
          <li>方案满周</li>
          </if>
          <if condition='$family.service_id neq ""'> 
          <li>参加活动</li>
        	</if>
        	<if condition="$family.insure_money egt 2000"> 
          <li>重要客户</li>
        	</if>
        	<if condition="$family.other_count gt 0"> 
          <li>有其他保单</li>
          </if>
        </ul>
      </div>
      <div style="border-bottom:1px solid #eee;padding:10px;font-size:14px;overflow:hidden;"> <span style="color:#999;margin-right:15px;">方案专家</span><span style="font-weight:800;color:#f24d4d;">{$family.report_admin.nickname}</span> </div>
      <div style="border-bottom:1px solid #ddd;padding:10px;font-size:14px;overflow:hidden;"> <span style="color:#999;margin-right:15px;">投保专家</span><span style="font-weight:800;color:#f24d4d;">{$family.insure_admin.nickname}</span> </div>
      <div style="font-size:14px;border-bottom:1px solid #ddd;padding:8px 10px;background-color:#fff;overflow:hidden;">
        <div style="color:#999;padding-bottom:8px;">对话要点</div>
        <ul>
         <foreach name="tags" item="ta">
        <li>{$ta['tag']}</li>
         </foreach> 
        </ul>
        <div style="background-color:#fff;color:#333;clear:both;">{$info}</div>
      </div>
      <div style="border-bottom:1px solid #eee;padding:10px;font-size:14px;"> <span style="color:#999;margin-right:15px;">服务状态</span><span style="color:#666;">{$family.service_time|date="Y年m月d日", ###} 生效</span> </div>
      <div style="border-bottom:1px solid #ddd;padding:10px;font-size:14px;"> <span style="color:#999;margin-right:15px;">最近登录</span><span style="color:#666;">{$user.lastlogin|date="Y年m月d日", ###}</span> </div>
    </div>
    <div style="float:right;width:77%;height:100%;margin-right:1%;">
      <div style="width:77%;height:5%;position:fixed;background-color:#3E4961;padding:1% 0;z-index:999;">
        <div style="height:40px;border-radius:5px;text-align:center;background-color:#69738C;color:#fff;">
          <div style="float:left;width:80px;font-size:14px;border-radius:5px 0 0 5px;border-right:1px solid #3E4961;line-height:40px;font-weight:800;" onClick="policy_tab(0)" class="seltab" id="tab_id0">家庭</div>
          <foreach name="reportlist" item="vo">
          		<div style="float:left;width:80px;font-size:14px;border-right:1px solid #3E4961;line-height:40px;" onClick="policy_tab({$vo.id})" class="unseltab" id="tab_id{$vo.id}">{$vo.level|getlevel}</div>
          </foreach>

          <div style="float:right;width:120px;line-height:24px;font-size:14px;background-color:#04BE02;color:#fff;border:1px solid #04BE02;margin:7px;border-radius:5px;">保存</div>
          <div style="float:right;width:60px;line-height:24px;font-size:14px;border:1px solid #ccc;margin:7px;border-radius:5px;">预览</div>
        </div>
      </div>
      <div style="margin-top:7%;right:1%;bottom:1%;width:30%;position:fixed;height:90%;background-color:#fff;border-radius:6px;">
        <div style="position:absolute;z-index:901;width:100%;background-color:#3E4961;height:10px;"></div>
        <div style="position:absolute;z-index:902;background-color:#eee;border-radius:6px 6px 0 0;width:100%;height:10px;"></div>
        <div style="padding:10px;background-color:#eee;height:20px;"><span style="float:left;font-weight:800;">家庭概览</span><span style="float:right;">保费：<span style="font-size:14px;color:#04BE02;line-height:20px;font-weight:800;">{$family.all_money}<span style="font-size:14px;color:#666;font-weight:400;">.78</span></span></span><span style="float:right;margin-right:15px;">保单：{$family.policy_count}</span></div>
        <div style="width:100%;border-bottom:1px solid #ddd;height:70px;">
          <div style="float:left;width:44%;border-right:1px solid #eee;padding:1% 3%;">
            <div style="line-height:30px;clear:both;border-bottom:1px solid #eee;"><span>保费总额</span><span style="font-size:14px;color:#666;margin-left:10px;line-height:30px;float:right;">{$family.policy_money}</span></div>
            <div style="line-height:30px;clear:both;"><span>过往保费</span><span style="font-size:14px;color:#666;margin-left:10px;line-height:30px;float:right;">{$family.other_money}</span></div>
          </div>
          <div style="float:right;width:43%;border-right:1px solid #eee;padding:1% 3%;">
            <div style="line-height:30px;clear:both;border-bottom:1px solid #eee;"><span>家庭年收入</span><span style="font-size:14px;color:#666;margin-left:10px;line-height:30px;float:right;">{$family.income}万元</span></div>
            <div style="line-height:30px;clear:both;"><span>总保费占比</span><span style="font-size:14px;color:#666;margin-left:10px;line-height:30px;float:right;">{$family.safe_scale}%</span></div>
          </div>
        </div>
        <foreach name="reportlist" item="vo">
        	<if condition="$vo['level'] neq 11">
        <div style="padding:10px;background-color:#999;height:20px;color:#fff;"><span style="float:left;font-weight:800;">{$vo.level|getlevel}</span><span style="float:right;">保费：<strong>：{$vo.money_count}</strong></span><span style="float:right;margin-right:15px;">保单：{$vo.policy_count}</span></div>
        <div style="width:100%;border-bottom:1px solid #ddd;height:100px;">
        
          <div style="float:left;width:44%;border-right:1px solid #eee;padding:1% 3%;">
            <div style="line-height:30px;clear:both;border-bottom:1px solid #eee;"><span>生日</span><span style="font-size:14px;color:#666;margin-left:10px;line-height:30px;float:right;"> {$vo.birthday|date="Y年m月d日", ###}</span></div>
            <div style="line-height:30px;clear:both;border-bottom:1px solid #eee;"><span>病史</span><span style="font-size:14px;color:#666;margin-left:10px;line-height:30px;float:right;">{$vo.case|caseList}</span></div>
            <div style="line-height:30px;clear:both;"><span>收入</span><span style="font-size:14px;color:#666;margin-left:10px;line-height:30px;float:right;">{$vo.income|floatval}万元</span></div>
          </div>
          <div style="float:right;width:43%;border-right:1px solid #eee;padding:1% 3%;">
            <div style="line-height:30px;clear:both;border-bottom:1px solid #eee;"><span>社保</span><span style="font-size:14px;color:#666;margin-left:10px;line-height:30px;float:right;"><if condition="$vo['social']">有<else/>无</if></span></div>
            <div style="line-height:30px;clear:both;border-bottom:1px solid #eee;"><span>过往保单</span><span style="font-size:14px;color:#666;margin-left:10px;line-height:30px;float:right;">3份</span></div>
            <div style="line-height:30px;clear:both;"><span>职业</span><span style="font-size:12px;color:#666;margin-left:10px;line-height:30px;float:right;width:10em; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:right">{$vo.work|work}</span></div>
          </div>
          
        </div>
      </if>
        </foreach>
        
		
        
      </div>
      
      <div id="tabs"  style="margin-top:88px;position:absolute;width:46%;">
      <div id="tab_0" class="ptab">
      
        <div style="width:100%;">
          <div style="height:auto;padding:10px;background-color:#ddd;color:#333;border-radius:5px 5px 0 0;font-size:14px;">家庭配置分析<span style="float:right">
          
          
            <select onChange="changeconf('0',this)">
                                    <foreach name="conf" item="vo">
                                        <option value="{$vo.id}">{$vo.title}</option>
                                    </foreach>
            </select>
            </span></div>
            
          <div style="font-size:14px;background-color:#eee;border-bottom:1px solid #eee;border-radius:0 0 5px 5px;">
            <textarea style="outline:none;resize:none;width:93.5%;height:200px;line-height:150%;font-size:14px;border:1px solid #ddd;margin:1.5% 1.5% 1%;padding:1% 1.5%;border-radius:5px;" placeholder="请输入家庭配置分析" name="suggest" id="conf_0">{$family.family_desc}</textarea>
          </div>
        </div>
        </div>
        <foreach name="reportlist" item="vo">
        <div id="tab_{$vo.id}"  class="ptab2">
        <div style="color:#fff;margin:20px 0;font-size:18px;padding:10px 10px 10px 20px;background-color:#000;color:fff;border-radius:5px;"><span style="margin-right:10px;font-weight:800;">{$vo.level|getlevel}</span><span style="color:#ccc;">{$vo.age}</span><span class="tab_dItem unselItem" >失效保单</span><span  class="tab_oItem unselItem" data_id="{$vo.id}">其他保单 {$vo.out_report_count}</span><span class="tab_pItem selItem" data_id="{$vo.id}">方案保单{$vo.policy_count}</span></div>
        <div id="pItem_{$vo.id}" class="pUser" data_age={$vo.age} data_gender={$vo.sex}>
        <foreach  name="vo.report" item="vi">
        <div style="width:100%;margin-bottom:20px;" data_status="{$vi.status}" class="pItem" data_id="{$vi.id}" data_pid="{$vi.product_id}">
          <div class="ptop_{$vi.status}" >
            
            <div class="left_info">{$vi.tl_info}</div>
            <if condition="$vi['status'] eq 0">
            <div class="tr_info">删除</div>
          	</if>
            <if condition="($vi['status'] eq 10) or ($vi['status'] eq 11) or ($vi['status'] eq 12)">
            <div class="tr_info">{$vi.order_time|date="Y年m月d日", ###}</div>
          	</if>
            <if condition="($vi['status'] eq 13) or ($vi['status'] eq 14) ">
            <div class="tr_info">{$vi.insure_time|date="Y年m月d日", ###}</div>
          	</if>
          </div>
          
          <div class="policy_div pclass">

          </div>
          <div class="policy_sel_div">
            
          </div>
          <div style="font-size:14px;padding:10px;background-color:#fff;border-bottom:1px solid #ddd;height:20px;clear:both;">
            <div style="float:left;margin-top:-3px;">计划保费<span style="margin-left:25px;padding:2px 10px 4px 1px;border:1px solid #ddd;width:160px;color:#999;">
              <input id="{$type}-company-{$rid}" type="text" name="{$rid}[company][]" class="form-control" value="{$vi.premium}" style="margin:0 0 0 -5px;padding:2px 10px;width:100px;border:0;line-height:20px;color:#04BE02;font-weight:800;">
              元 </span><span style="border:1px solid #ddd;border-radius:3px;padding:2px 10px;margin-left:20px;font-size:12px;color:#666;">计算器</span> </div>
          </div>
          <div style="clear:both;padding:10px;background-color:#fff;border-radius:0 0 5px 5px;height:35px;text-align:center;font-size:14px;background-color:#eee;">
          	<div class="save_btn">保存</div>
            <div class="bl_info">产品详情</div>
            <div class="bl_info">投保链接</div>
            <div class="bl_info">投保须知</div>
            <div class="bl_info">保险条款</div>
            <div class="br_btn2"></div>
            <div class="br_btn"></div>
          </div>
        </div>
        </foreach>
        <div style="width:100%;margin-bottom:20px;">
          <div class="add_btn">+ 增加产品</div>
        </div>
        </div>
        <div id="oItem_{$vo.id}">
        <foreach name="vo.out_report" item="vn">
         <div style="width:100%;margin-bottom:20px;">
          <div style="padding:0 10px 0;height:31px;background-color:#04BE02;color:#fff;border-radius:5px 5px 0 0;">
            <div style="font-size:10px;margin:5px 10px 5px 0;padding:2px 10px;background-color:#fff;border-radius:5px;float:left;color:#333;">{$vn.level}</div>
            
            <div style="font-size:10px;margin:5px 0 5px 10px;padding:2px 0;border-radius:5px;float:right;color:#fff;">生效日期：{$vn.start_date|date="Y年m月d日", ###}</div>
          </div>
          <div style="font-size:18px;padding:10px;background-color:#fff;border-bottom:1px solid #eee;height:22px;">{$vn.product_name}<span style="padding:2px 10px;border:1px solid #eee;margin-left:20px;font-size:16px;color:#bbb;border-radius:5px;">{$vn.order_company}</span> </div>
          <div style="font-size:14px;padding:10px;background-color:#fff;border-bottom:1px solid #eee;height:20px;">
            <div style="float:left;width:50%;border-right:1px solid #eee;">保单号<span style="padding-left:20px;font-weight:800;">{$vn.order_number}</span></div>
            <div style="float:left;margin-left:10px;">投保人<span style="padding-left:20px;font-weight:800;">{$vn.toubao_name}</span></div>
          </div>
          <div style="font-size:14px;padding:10px;background-color:#fff;border-bottom:1px solid #eee;height:20px;">
            <div style="float:left;width:50%;border-right:1px solid #eee;">保障期限<span style="padding-left:20px;font-weight:800;">{$vn.insure_date}</span></div>
            <div style="float:left;margin-left:10px;">保额<span style="padding-left:20px;font-weight:800;">{$vn.insure_total}</span></div>
          </div>
          <div style="font-size:14px;padding:10px;background-color:#fff;border-bottom:1px solid #eee;height:20px;">
            <div style="float:left;width:50%;border-right:1px solid #eee;">缴费年限<span style="padding-left:20px;font-weight:800;">{$vn.payment_date}年</span></div>
            <div style="float:left;margin-left:10px;">保人<span style="padding-left:20px;font-weight:800;">投保人豁免</span></div>
          </div>
          <div style="font-size:14px;padding:10px;background-color:#fff;border-bottom:1px solid #eee;height:20px;">
            <div style="float:left;width:50%;border-right:1px solid #eee;">订单保费<span style="padding-left:20px;"><span style="color:#04BE02;font-weight:800;">{$vn.premium}元</span></div>
          </div>
        </div>
        </foreach>
        </div>
        <div id="dItem_{$vo.id}">
        </div>

        <div style="width:100%;;margin-bottom:10px;">
          <div style="height:auto;padding:10px;background-color:#ddd;color:#333;border-radius:5px 5px 0 0;font-size:14px;">配置分析<span style="float:right">
            
            <select onChange="changeconf('{$vo.level}',this)" style="width:200px;font-size:14px;margin-top:-5px;padding:3px 5px;border:1px solid #ccc;">
                                    <foreach name="vo.conf" item="vm">
                                        <option value="{$vm.id}">{$vm.title}</option>
                                    </foreach>
            </select>
            </span></div>
          <div style="font-size:14px;background-color:#eee;border-bottom:1px solid #eee;border-radius:0 0 5px 5px;">
            <textarea style="outline:none;resize:none;width:93.5%;height:200px;line-height:150%;font-size:14px;border:1px solid #ddd;margin:1.5% 1.5% 1%;padding:1% 1.5%;border-radius:5px;" placeholder="请输入配置分析" name="suggest" id="conf_{$vo.level}"></textarea>
          </div>
        </div>
        </div>
        </foreach>
                <if condition="$family.otherMembers eq 0">
        <div id="tab_00" class="ptab2">

         <div style="width:100%;margin-bottom:20px;">
          <div class="add_btn">+ 增加产品</div>
        	</div>
        <div style="width:100%;">
          
        </div>
        </div>
      </if>
      <div class="ptab2 hide_div" id="new_pItem">
<div style="width:100%;margin-bottom:20px;" data_status="0" class="pItem" data_id="0" data_pid="0">
          <div class="ptop_0" >
            
            <div class="left_info">尚未预约</div>
                                          
            <div class="tr_info del_info">删除</div>
          </div>
          
          <div class="policy_div pclass">
          </div>
          <div class="policy_sel_div">
          
          	
          </div>
          <div style="font-size:14px;padding:10px;background-color:#fff;border-bottom:1px solid #ddd;height:20px;clear:both;">
            <div style="float:left;margin-top:-3px;">计划保费<span style="margin-left:25px;padding:2px 10px 4px 1px;border:1px solid #ddd;width:160px;color:#999;">
              <input id="{$type}-company-{$rid}" type="text" name="{$rid}[company][]" class="form-control" value="{$vi.premium}" style="margin:0 0 0 -5px;padding:2px 10px;width:100px;border:0;line-height:20px;color:#04BE02;font-weight:800;">
              元 </span><span style="border:1px solid #ddd;border-radius:3px;padding:2px 10px;margin-left:20px;font-size:12px;color:#666;">计算器</span> </div>
          </div>
          <div style="clear:both;padding:10px;background-color:#fff;border-radius:0 0 5px 5px;height:35px;text-align:center;font-size:14px;background-color:#eee;">
          	<div class="save_btn">保存</div>
            <div class="bl_info">产品详情</div>
            <div class="bl_info">投保链接</div>
            <div class="bl_info">投保须知</div>
            <div class="bl_info">保险条款</div>
            <div class="br_btn2"></div>
            <div class="br_btn"></div>
          </div>
</div>
</div>
        </div>

      </div>
    </div>
  </div>
</div>

</body>
    <script src="__PUBLIC__/js/jquery.min.js"></script>
    <script src="__PUBLIC__/js/bootstrap.min.js"></script>
    <script src="__PUBLIC__/js/content.min.js"></script>
    <script src="__PUBLIC__/js/plugins/layer/layer.js"></script>
    <script type="text/javascript">
	var productCategory='{$productCategory}';
	var productJson=JSON.parse(productCategory);
	//alert(productJson[0]['cid']);
	 var product = {};
	 var productID =Array();
	 for(var i=0;productID.lenght;i++)
	 {
		 getproduct(productID[i]);
	 }
	 function getproduct(id)
	 {
		 if (product[id] !== null || product[id] !== undefined || product[id] !== '') 
		 {
            var data={pid:id};
            $.ajax({
                url:"{:U('Compute/getComputeOpt')}",
                data:data,
				async: false,
                success:function(data){
					var dataJson=JSON.parse(data);
                    if(dataJson['status']==1){
                        product[dataJson.product_id]=dataJson;
						return true;
                    }
                }
            })
			return false;
		 }
	 }
	 function ProductHtml(id)
	 {
		 var data = product[id]['opt'];
		 
		 var str="";
		 
		 for(var i=0;i<data.length;i++)
		 {
		 	
			 	if(i%2==0)
			 	{
			 			str += '<div class="policy_div"><div class="pdiv_left">'+data[i]['title']+'<span><select name="'+data[i]['name']+'" class="pSelItem">';
			 	}
			 	else
			 	{
			 			str += '<div >'+data[i]['title']+'<span><select name="'+data[i]['name']+'" class="pSelItem">';	
			 	}
			 	for(var k=0;k<data[i]['opt'].length;k++)
			 	{
			 		if(data[i]['opt'][k]['d'] !== undefined && data[i]['opt'][k]['d'] == 1)
			 			str += '<option value="'+data[i]['opt'][k]['v']+'" selected>'+data[i]['opt'][k]['t']+'</option>';
			 		else
			 			str += '<option value="'+data[i]['opt'][k]['v']+'">'+data[i]['opt'][k]['t']+'</option>';
			 	}
			 	if(i%2==0)
			 	{
			 			str += '</select></span></div>';
			 	}
			 	else
			 	{
			 			str += '</select></span></div></div>';	
			 	}
		 }
		 if(data.length%2==1)
		 {
		 	str += '</div>';	
		 }
		 return str;
	 }

	 function AddProductObject(id,name,title)
	 {
	 	
	 	var data= JSON.parse(product[id][name]);
	 	var opt= {};
	 	opt['title'] = title;
		opt['name'] = name;
		opt['opt'] = data['sel'];
		var i =product[id]['opt'].length;
		product[id]['opt'][i]=opt;
		product[id][name]=data;
	 }
	 function KeyValue(str,s)
	 {
	 	var data={};
	 	var strs = str.split(s);
	 	data['key']= strs[0];
	 	if(strs.length >1)
	 		data['value']= strs[1];
	 	else
	 		data['value']= '';
	 	return data;
	 }
	 function ProductEvent(div,id,type,value)
	 {
	 	
	 	var e = product[id][type]['event'];
	 	if(e == undefined)
	 	return ;
	 	for(var i=0;i < e.length;i++)
	 	{
	 		var to = e[i]['to'];
			
			var count =100;
	 		for(var k = 0; k < e[i]['evs'].length;k++)
	 		{
	 			if((e[i]['evs'][k]['t'] =='value' && e[i]['evs'][k]['v'] ==value) ||(e[i]['evs'][k]['t'] =='range' && e[i]['evs'][k]['s'] >value && e[i]['evs'][k]['e'] <= value))
	 			{
	 				if(e[i]['evs'][k]['rt']=="count")
	 				{
	 					
	 					count = e[i]['evs'][k]['rv'];
	 					if(e[i]['evs'][k]['ov'] !== undefined && e[i]['evs'][k]['ov'].length > 0)
	 					{
	 						var ov = e[i]['evs'][k]['ov'];
	 						
	 						for(var x = 0; x < ov.length;x++)
	 						{
	 							var val = div.closest(".policy_sel_div").find(":input[name='"+ov[x]['n']+"']").val();
	 							if((ov[x]['t'] =='value' && ov[x]['v'] == val) ||(ov[x]['t'] =='range' && ov[x]['s'] > val && ov[x]['e'] <= val))
	 							{
	 								
	 							}
	 							else
	 							{
	 									count =100;
	 									break;
	 							}
	 						}
	 					}
	 					

	 				}
	 			}
	 		}
	 		
    	NewProductItem(div.closest(".policy_sel_div").find(":input[name='"+to+"']"),product[id][to]['sel'],count);
	 	}
	 }
	 function NewProductItem(ob,list,count)
	 {
	 	
	 		var str="";
	 		if(count >list.length)
	 			count = list.length;
	 		var i = ob.get(0).selectedIndex;
	 		
	 		for(var k = 0; k < count;k++)
	 		{
	 			if(k == i)
	 				str += '<option value="'+list[k]['v']+'" selected>'+list[k]['t']+'</option>';
	 			else
	 				str += '<option value="'+list[k]['v']+'">'+list[k]['t']+'</option>';
	 		}
	 		ob.html(str);
	 		//alert(str);
	 }
	 
	 function ProductItem(id)
	 {
	 	 product[id]['opt'] = Array();
	 	 
		 if(product[id]['type'].length > 0)
		 {
		 	AddProductObject(id,'type','产品选项');
		 }
		 if(product[id]['amount'].length > 0)
		 {
		 	AddProductObject(id,'amount','保障额度');
		 }
		 if(product[id]['add_amount'].length > 0)
		 {
		 	AddProductObject(id,'add_amount','附加保额');
		 }
		 if(product[id]['del_amount'].length > 0)
		 {
		 	AddProductObject(id,'del_amount','免赔额');
		 }
		 if(product[id]['term'].length > 0)
		 {
		 	AddProductObject(id,'term','保障期限');
		 }
		 if(product[id]['pay_mode'].length > 0)
		 {
		 	AddProductObject(id,'pay_mode','缴费方式');
		 }
		 if(product[id]['pay_year_count'].length > 0)
		 {
		 	AddProductObject(id,'pay_year_count','缴费年限');
		 }
		 if(product[id]['exemption'].length > 0)
		 {
		 	AddProductObject(id,'exemption','保费豁免');
		 }
		 if(product[id]['medical_insurance'].length > 0)
		 {
		 	AddProductObject(id,'medical_insurance','医疗保险');
		 }
		 if(product[id]['age'].length > 0)
		 {
		 	product[id]['age']=JSON.parse(product[id]['age']);
		 }
		 if(product[id]['gender'].length > 0)
		 {
		 	product[id]['gender']=JSON.parse(product[id]['gender']);
		 }
	 }
	function AddProduct(div,st,pid)
	{
		if(st ==0)
		{
			AddProductNameSelect(div,pid);
		}
		else
		{
			AddProductNameText(div,pid);
		}
	}
	function AddProductNameText(div,pid)
	{
		 var cid = 0;
		 var pc_name = "";
		 
		 for(var i=0;i<productJson.length;i++)
		 {
			 
			 var pt = productJson[i]['ptitle'];
			 for(var k=0;k<pt.length;k++)
			 {
					 if(parseInt(pt[k]['id']) == pid)
					 {
						 cid = parseInt(pt[k]['cid']);
						 pc_name = "<em>"+ pt[k]['title'] +"</em>";
						 break;
					 }
			 }
			 if(parseInt(productJson[i]['cid']) == cid)
			 {
				 pc_name +="<b class='pc_name'>"+productJson[i]['cname']+"</b>";
			 }
			 
		 }
		 
		 $(div).find(".pclass").html(pc_name);

	}
	 function AddProductNameSelect(div,pid)
	 {
		 var cid = 0;
		 var sel_left;
		 var sel_right;
		 sel_left ='<select name="select" class="selLeft" >';
		 if(pid == 0)
		 {
			 sel_left +="<option value='0'>请选择</option>";
		 }
		 sel_right ='<select name="select" class="selRight" >';
		 
		 for(var i=0;i<productJson.length;i++)
		 {
			 
			 var pt = productJson[i]['ptitle'];
			 for(var k=0;k<pt.length;k++)
			 {
				 if(cid != parseInt(pt[k]['cid']))
				 {
					 if(parseInt(pt[k]['id']) == pid)
					 {
						 cid = parseInt(pt[k]['cid']);
						 
						 k=-1;
					 }
				 }
				 else
				 {
					 
					 if(parseInt(pt[k]['id']) == pid)
					 {
						 sel_right +="<option value='"+pt[k]['id']+"' selected>"+pt[k]['title']+"</option>";
					 } 
					 else
					 {
						 sel_right +="<option value='"+pt[k]['id']+"'>"+pt[k]['title']+"</option>";
					 }
				 }
			 }
			 if(parseInt(productJson[i]['cid']) == cid)
			 {
				 sel_left +="<option value='"+productJson[i]['cid']+"' selected>"+productJson[i]['cname']+"</option>";
			 } 
			 else
			 {
				 sel_left +="<option value='"+productJson[i]['cid']+"'>"+productJson[i]['cname']+"</option>";
			 }
			 
		 }
		 sel_left +="</select>";
		 sel_right +="</select>";
		 
		 $(div).find(".pclass").html(sel_left+sel_right);

	 }
	$(".add_btn").click(function(){
		
  		$(this).parent().before($("#new_pItem").html());
		
		
	});
	</script>
    <script type="text/javascript">
        function changeconf(level,op){
            var id={id:op.value};
            $.ajax({
                url:"{:U('Template/ajaxTemConf')}",
                data:id,
                success:function(data){
                    if(data.status==1){
                        $("#conf_"+level).val(data.desc);
                    }
                }
            })
        }
	var old_id = "0";
	function policy_tab(id)
	{
		$('.ptab2').hide();
		$('.ptab').hide();
		$("#tab_"+id).show();
		
		$("#tab_id"+id).addClass('seltab');
		$("#tab_id"+id).removeClass('unseltab');
		
		$("#tab_id"+old_id).addClass('unseltab');
		$("#tab_id"+old_id).removeClass('seltab');
		old_id = id;
		//$("#tabs").scrollTop(0);
		$(window).scrollTop(0);
	}
	$(".tab_oItem").click(function(){
  		var id = $(this).attr("data_id");
		$("#oItem_"+id).show();
		$("#pItem_"+id).hide();
		$("#dItem_"+id).hide();
		var p=$(this).parent();
		$(this).addClass('selItem');
		$(this).removeClass('unselItem');
		p.children('.tab_pItem').removeClass('selItem');
		p.children('.tab_pItem').addClass('unselItem');
		p.children('.tab_dItem').removeClass('selItem');
		p.children('.tab_dItem').addClass('unselItem');
	});
	$(".tab_pItem").click(function(){
  		var id = $(this).attr("data_id");
		$("#pItem_"+id).show();
		$("#oItem_"+id).hide();
		$("#dItem_"+id).hide();
		var p=$(this).parent();
		$(this).addClass('selItem');
		$(this).removeClass('unselItem');
		p.children('.tab_oItem').removeClass('selItem');
		p.children('.tab_oItem').addClass('unselItem');
		p.children('.tab_dItem').removeClass('selItem');
		p.children('.tab_dItem').addClass('unselItem');
	});
	$(".tab_dItem").click(function(){
  		var id = $(this).attr("data_id");
		$("#dItem_"+id).show();
		$("#oItem_"+id).hide();
		$("#pItem_"+id).hide();
		var p=$(this).parent();
		$(this).addClass('selItem');
		$(this).removeClass('unselItem');
		p.children('.tab_pItem').removeClass('selItem');
		p.children('.tab_pItem').addClass('unselItem');
		p.children('.tab_oItem').removeClass('selItem');
		p.children('.tab_oItem').addClass('unselItem');
	});
	Init_PList();
	function Init_PList()
	{
		
		$("#tabs .ptab2").each(function(){
			
          $(this).find(".pItem").each(function(){
			  var st = parseInt($(this).attr("data_status"));
			  var pid = parseInt($(this).attr("data_pid"));
			  AddProduct(this,st,pid);
			  if(st == 0)
			  {
			  	$(this).find(".tr_info").addClass('del_info');
				$(this).find(".br_btn").addClass('hide_btn');
				$(this).find(".br_btn2").addClass('normal_btn');
				$(this).find(".br_btn2").addClass('act_addOrder');
				$(this).find(".br_btn2").html("帮她预约");
				$(this).find(".left_info").html("尚未预约");
				
				
			  }
			  if(st == 10)
			  {
			  	$(this).find(".tr_info").addClass('order_info');
				$(this).find(".br_btn").addClass('normal_btn');
				$(this).find(".br_btn").addClass('act_unOrder');
				$(this).find(".br_btn2").addClass('enter_btn');
				$(this).find(".br_btn2").addClass('act_enterOrder');
				$(this).find(".br_btn").html("取消预约");
				$(this).find(".br_btn2").html("确定投保");
				$(this).find(".left_info").html("正在确认");
			  }
			  if(st == 11)
			  {
			  $(this).find(".tr_info").addClass('order_info2');
				$(this).find(".br_btn").addClass('hide_btn');
				$(this).find(".br_btn2").addClass('normal_btn');
				$(this).find(".br_btn2").addClass('act_addOrder');
				$(this).find(".br_btn2").html("取消预约");
				$(this).find(".left_info").html("投保失败");
			  }
			  if(st == 12)
			  {
			  	$(this).find(".tr_info").addClass('order_info2');
				$(this).find(".br_btn").addClass('normal_btn');
				$(this).find(".br_btn").addClass('act_unOrder');
				$(this).find(".br_btn2").addClass('orderOK_btn');
				$(this).find(".br_btn2").addClass('act_OrderOK');
				$(this).find(".br_btn").html("取消预约");
				$(this).find(".br_btn2").html("投保成功");
				$(this).find(".left_info").html("正在投保");
			  }
			  if(st== 13 ||st == 14)
			  {
			  	$(this).find(".tr_info").addClass('order_info');
				$(this).find(".br_btn").addClass('hide_btn');
				$(this).find(".br_btn2").addClass('hide_btn');
				$(this).find(".left_info").html("犹豫期");
				if(st ==14)
				$(this).find(".left_info").html("投保成功");

			  }
		  });
		});
		var delProductUrl = "{:U('user/delProduct')}";

		$(".del_info").click(function(){
				var id=$(this).parent().parent().attr('data_id');
				//alert(id);
				if(id == 0){
					$(this).parent().remove();
				}else{
					layer.confirm('您确定要删除这个产品吗', {icon: 0, title:'提示'}, function(){
						$.post(delProductUrl,{'id':id},function(data){
							if(data.status){
								layer.msg('删除成功', {icon: 1});
								$(this).parent().parent().remove();
							}else{
								layer.msg('删除失败', {icon: 2});
							}
						},'json')
					},function(index){
						layer.close(index);
					});		
				}
		});
		
		//sel_fun();


	}
	function getSelValue(div,type)
	{
		var s = div.find(":input[name='"+type+"']").val();
		if(s !== undefined)
			return s;
		return 0;
	}
var money_id = 0;
	function getMoney(pid,div){
		
		money_id++;
		div.closest(".pItem").find(".form-control").attr("moneyID",money_id);
		
		var data={};
		data['money_id'] = money_id;
		data['product_id'] = pid;
		data['type'] = getSelValue(div,'type');
		data['amount'] = getSelValue(div,'amount');
		data['add_amount'] = getSelValue(div,'add_amount');
		data['del_amount'] = getSelValue(div,'del_amount');
		data['age'] = getSelValue(div,'age');
		data['gender'] = getSelValue(div,'gender');
		data['term'] = getSelValue(div,'term');
		data['pay_mode'] = getSelValue(div,'pay_mode');
		data['pay_year_count'] = getSelValue(div,'pay_year_count');
		data['exemption'] = getSelValue(div,'exemption');
		data['medical_insurance'] = getSelValue(div,'medical_insurance');
           
            $.ajax({
                url:"{:U('Compute/getComputeMoney')}",
                data:data,
				async: false,
                success:function(data){
                	
					var dataJson=JSON.parse(data);
                    if(dataJson['status']==1){
                        
                        var mi = div.closest(".pItem").find(".form-control");
                        
                        if(mi.attr("moneyID") == dataJson['money_id'])
                        {
                        	mi.val(Number(dataJson['money'])/100);
                        }
                        	
						return true;
                    }
                }
            })
			return false;
					
		}

$(".ptab2").on("change",".selRight", function() {
		   var pid = parseInt($(this).val());
		   getproduct(7);
		   ProductItem(7);
		   var str = ProductHtml(7);
		   var pid = $(this).val();
		    
		   $(this).closest(".pItem").attr('data_pid',pid);
		   var age = $(this).closest(".pUser").attr('data_age');
		   var gender = $(this).closest(".pUser").attr('data_gender');
		   str +='<input type="hidden" name="age" value="'+age+'">';
		   str +='<input type="hidden" name="gender" value="'+gender+'">';
		   $(this).closest(".pItem").find(".policy_sel_div").html(str);
 });
$(".ptab2").on("change",".selLeft", function() {
	
		   var cid = parseInt($(this).val());
			var sel_right="";
		   for(var i=0;i<productJson.length;i++)
		   {
			   
			   if(parseInt(productJson[i]['cid']) == cid)
			   {
				   var pt = productJson[i]['ptitle'];
			 		sel_right +="<option value='0'>请选择</option>";
				   for(var k=0;k<pt.length;k++)
				   {
					   
						sel_right +="<option value='"+pt[k]['id']+"'>"+pt[k]['title']+"</option>";
						
				   }
			   }
			   
		   }

		   $(this).parent().find(".selRight").html(sel_right);
 });
$(".ptab2").on("change",".pSelItem", function() {
     var type = $(this).attr('name');
     var id = $(this).closest(".pItem").attr('data_pid');
     
     var value = $(this).get(0).selectedIndex;
     
     ProductEvent($(this),7,type,value);
     getMoney(7,$(this).closest(".policy_sel_div"));
 });

	</script>
</html>
