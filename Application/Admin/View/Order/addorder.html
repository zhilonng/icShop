<!DOCTYPE html>
<html>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服装管理</title>
    <link rel="shortcut icon" href="favicon.ico"> <link href="__PUBLIC__/css/bootstrap.min.css" rel="stylesheet">
    <link href="__PUBLIC__/css/font-awesome.min.css" rel="stylesheet">
    <link href="__PUBLIC__/css/animate.min.css" rel="stylesheet">
    <link href="__PUBLIC__/css/style.min.css" rel="stylesheet">
    <link href="__PUBLIC__/css/fileupload/jquery.fileupload-ui.css" rel="stylesheet">
    <link href="__PUBLIC__/css/fileupload/jquery.fileupload.css" rel="stylesheet">
    <style type="text/css">
    #album-list{ padding: 20px 0px 20px  0%;}
    #album-list li{float: left; width: 20%;text-align: center;border:1px solid #ccc;max-height: 200px;overflow: hidden;margin-right: 10px;border-radius: 5px;padding:10px;}
    #album-list li img{width: 100%;max-height: 150px;}
    #album-list li p{ padding: 10px 0px;}
    em{color: red};

    </style>
</head>
<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title" >
                        <h5>添加生产订单
                    </div>
                    <div class="ibox-content">
                        <form method="post" class="form-horizontal" id="masterForm" onkeydown="if(event.keyCode==13)return false;" action="?" enctype="multipart/form-data" >
                            <input type="hidden" name="order_user_id" value='{$Think.session.username}'></input>
                            <input type="hidden" id="imgpath" name="imgpath" value=""></input>
                            <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>产品款号</label>
                                <div class="col-sm-4">
                                    <input type="text" placeholder="此项必须填写" class="form-control" name="order_style_number" onblur="return checkno(this)"  value="{$list.order_style_number}">
                                </div>
                            </div>
                            <!-- 订单工厂 -->
                            <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>工厂</label>
                                <div class="col-sm-4">
                                    <select  class="form-control m-b" name="order_factory">
                                        <option value="0">请选择</option>
                                        <foreach name="factory" item="vo">
                                            <option value="{$vo.factory_id}">{$vo.factory_name}</option>
                                        </foreach>
                                    </select>
                                </div>
                            </div>
                            <!-- 工厂结束 -->
                            <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>设计师</label>
                                <div class="col-sm-4">
                                    <select  class="form-control m-b" name="order_designer">
                                        <option value="0">请选择</option>
                                        <foreach name="designer" item="vo">
                                            <option value="{$vo.designer_id}">{$vo.designer_name}</option>
                                        </foreach>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>纸样师</label>
                                <div class="col-sm-4">
                                    <select  class="form-control m-b" name="order_paper">
                                        <option value="0">请选择</option>
                                        <foreach name="paper" item="vo">
                                            <option value="{$vo.paper_id}">{$vo.paper_name}</option>
                                        </foreach>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>产品款式</label>
                                <div class="col-sm-4">
                                   <input type="text" placeholder="此项必须填写" class="form-control" name="order_category" value="{$list.order_category}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>下单日期</label>
                                <div class="col-sm-4">
                                    <input type="text" placeholder="此项必须填写" name="order_date" class="form-control" id="start"  value="{$list.order_date}">
                                </div>
                            </div>

<!--                             <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>品牌</label>
                                <div class="col-sm-4">
                                    <select  class="form-control m-b" name="order_logo">
                                        <option value="0">请选择</option>
                                        <foreach name="logo" item="vo">
                                            <option value="{$vo.logo_id}">{$vo.logo_name}</option>
                                        </foreach>
                                    </select>
                                </div>
                            </div>
 --><!--                             <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>面料成本</label>
                                <div class="col-sm-4">
                                    <input type="text" placeholder="此项必须填写" name="order_mmoney" class="form-control"   value="{$list.order_mmoney}">
                                </div>
                            </div>
 -->                            <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>面辅料成本</label>
                                <div class="col-sm-4">
                                    <input type="text" onblur="addtotal()" placeholder="此项必须填写" name="order_mfmoney" class="form-control"   value="{$list.order_mfmoney}">
                                </div>
                            </div>

                            <!-- 加工费开始 -->
                            <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>加工费</label>
                                <div class="col-sm-4">
                                    <input type="text" onblur="addtotal()" placeholder="此项必须填写" name="order_fmoney" class="form-control"  value="{$list.order_fmoney}">
                                </div>
                            </div> 
                            <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>总成本</label>
                                <div class="col-sm-4">
                                    <input type="text"  readonly="readonly"  class="form-control" name="order_allmoney" value="{$list.order_allmoney}">
                                </div>
                            </div>
                            <!-- 零售价结束 -->                                                       
                            <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>裁床数(件)</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" readonly="readonly" name="order_quantity" value="0">
                                </div>
                            </div>
<!--                         <div class="hr-line-dashed"></div>
                          <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>针织或梭织</label>
                                <div class="col-sm-4">
                                    <label><input name="order_zhensuo" type="radio" value="0" />针织 </label> 
                                     <label><input name="order_zhensuo" type="radio" value="1" />梭织 </label> 
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>印花或绣花</label>
                                <div class="col-sm-4">
                                    <label><input name="order_xiuyin" type="radio" value="0" />无 </label> 
                                     <label><input name="order_xiuyin" type="radio" value="1" />绣花</label> 
                                      <label><input name="order_xiuyin" type="radio" value="2" />印花</label> 
                                </div>
                            </div>
 -->
<!--                              <div class="form-group">
                                <label class="col-md-2 control-label">货期</label>
                                <div class="col-md-4">
                                    <input type="text" name="order_delivery" placeholder="没有可不填" class="form-control" value="{$list.order_delivery}">
                                </div>
                            </div> -->

                        <div class="copy">
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
        <!--                     <div class="colorbox"> -->
                                <label class="col-sm-2 control-label"><em>*</em>颜色</label>
                                <div class="col-sm-4" style="display: flex;flex-wrap: wrap;">
                                    <select  class="form-control" id="ajaxchange"  name="order_color[]">
                                    <option value="0">请选择</option>
                                        <foreach name="color" item="vo">
                                            <option value="{$vo.id}">{:str_repeat('&nbsp;', $vo['level']*4)} {$vo['color_name']}</option>
                                        </foreach>
                                    </select>
                                </div>
                           </div>       
                            <div class="form-group">
              <!--                   <div class="sizebox"> -->
                                    <label class="col-sm-2 control-label"><em>*</em>尺码</label>
                                    <div class="col-sm-4">
                                    <select  class="form-control" id="ajaxsize"  name="order_size[]">
                                    <option value="0">请选择</option>
                                        <foreach name="size" item="vo">
                                            <option value="{$vo.id}">{:str_repeat('&nbsp;', $vo['level']*4)} {$vo['size_name']}</option>
                                        </foreach>
                                    </select>
                                    </div> 
                            </div>

                            <div class="form-group">
                                <label class="col-sm-2 control-label"><em>*</em>裁床数(件)</label>
                                <div class="col-sm-4">
                                    <input type="text" placeholder="此项必须填写"  onblur="return addcuttable(this)" class="form-control" name="order_total[]" value="{$list.order_total}">
                                </div>
                            </div>
                             <div class="form-group">
                                <label class="col-sm-2 control-label"></label>
                                <div class="col-sm-4">
                                    <a onclick="return copy_row(this)">[+]</a>
                                </div>
                            </div>
                        </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-md-2 control-label now_num" style="width: 30%">已经添加1颜色</label>
                                <a  class="check" style="margin-left: 5%" onclick="checkall()">点击检查颜色尺码</a>
                                <div style="margin-left: 10%" id="check">
                                </div>
                            </div> 
                            <div class="hr-line-dashed"></div> 
                            <div class="form-group">
                                <label class="col-md-2 control-label">订单备注</label>
                                <div class="col-md-6">
                                    <textarea name="order_remarks" id="text" class="form-control" style="height:120px;">{$list.order_remarks}</textarea>
                                </div>
                            </div>    
                         <div class="hr-line-dashed"></div>
                                                 <!-- 图片添加 -->
                           <div class="form-group">
                            <label class="col-md-2 control-label">图片</label>
<div class="row fileupload-buttonbar" style="padding-left:15px;">  
<div class="thumbnail col-sm-6">  
<img id="weixin_show" style="height:180px;margin-top:10px;margin-bottom:8px;"  src="{$list.order_pic}" data-holder-rendered="true">  
<div class="progress progress-striped active" role="progressbar" aria-valuemin="10" aria-valuemax="100" aria-valuenow="0"><div id="weixin_progress" class="progress-bar progress-bar-success" style="width:0%;"></div></div>  
<div class="caption" align="center">  
<span id="weixin_upload" class="btn btn-primary fileinput-button">  
<span>选择上传</span>  
<input type="file" id="weixin_image" name="weixin_image" multiple>
</span>  
<a id="weixin_cancle" href="javascript:void(0)" class="btn btn-warning" role="button" onclick="cancleUpload(this)" style="display:none">删除</a>  
</div>  
</div>  
</div>  


                            <div class="form-group">
                                <label class="col-md-2 control-label">添加时间</label>
                                <div class="col-md-4">
                                    <input type="text" readonly="readonly" name="order_addtime" class="form-control" value="{:date('Y-m-d H:i:s')}">
                                </div>
                            </div>    
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-sm-4 col-sm-offset-2">
                                    <button class="btn btn-primary" type="submit">保存内容</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="__PUBLIC__/js/jquery.min.js"></script>
    <script src="__PUBLIC__/js/bootstrap.min.js"></script>
    <script src="__PUBLIC__/js/content.min.js"></script>
    <script src="__PUBLIC__/js/plugins/layer/layer.js"></script>
    <script src="__PUBLIC__/js/plugins/layer/laydate/laydate.js"></script>
    <script src="__PUBLIC__/js/fileupload/jquery.ui.widget.js"></script>
    <script src="__PUBLIC__/js/fileupload/jquery.fileupload.js"></script>
    <script src="__PUBLIC__/js/fileupload/jquery.iframe-transport.js"></script>
    <script type="text/javascript">
     laydate({elem:"#start",event:"focus"});
     $(function(){
                 //JS获取上传文件的绝对路径
          $("#weixin_image").fileupload({  
            url: '__CONTROLLER__/uploadImg',  
            sequentialUploads: true  
            }).bind('fileuploadprogress', function (e, data) {  
                var progress = parseInt(data.loaded / data.total * 100, 10);  
                $("#weixin_progress").css('width',progress + '%');  
                $("#weixin_progress").html(progress + '%');  
            }).bind('fileuploaddone', function (e, data) {  
                console.log(data.result)
                $('#imgpath').val(data.result);
                $("#weixin_show").attr("src",data.result);  
                $("#weixin_upload").css({display:"none"});  
                $("#weixin_cancle").css({display:""});  
            }); 
     })
    function copy_row(obj){
        console.log(1)
        var $tr=$(obj ).parents('.copy');
        if(obj.innerHTML=='[+]'){
            var $clone=$tr.clone();
            $clone.find('a' ).html('[-]');
            var $last=$('.copy:last');
            $last.after($clone);
            var num=$('.copy').size();
            $('.now_num').html('当前已添加'+num+'种');
        }else{
            if(confirm('确定删除吗?')){
                var val=$tr.find($('input[name="order_total[]"]')).val();
                val=parseInt(val);
                var total=$('input[name="order_quantity"]').val();
                total=parseInt(total);
                total-=val;
                $('input[name="order_quantity"]').val(total);
                $tr.remove();
                var num=$('.copy').size();
                $('.now_num').html('当前已添加'+num+'种');

            }
        }
    }
    function cancleUpload(obj){
        //console.log()
        var path=$('#weixin_show').attr('src');
        console.log(path);
        $.post("{:U('/Admin/Order/delimg')}",{path:path},function(data){
            if(data==1){
                layer.msg('删除成功');
                $('#weixin_show').attr('src',"{$list.order_pic}");
                $("#weixin_upload").css({display:""});  
                $("#weixin_cancle").css({display:"none"}); 
                $('#imgpath').val('');
            }else{
                layer.msg('删除失败,请重试');
            }
        })
    } 
    function addcuttable(obj){
        //console.log($('input[name="order_total[]"]'));
        var data=$('input[name="order_total[]"]');
        var total=0;
        $(data).each(function(k,v){
            total+=parseInt($(v).val());
        })
        $('input[name="order_quantity"]').val(total);
    }
        function check2()
    {
        var arr=[];
        var color='';
        var size='';
        var string='';
        $('.copy').each(function(k,v){
            color=$(v).find($('select[name="order_color[]"]')).val()
            size=$(v).find($('select[name="order_size[]"]')).val()
            string=color+'.'+size
            $(arr).each(function(key,val){
                if(string==val){
                    alert('重复');
                    return false;
                }
            })
            arr.push(string)
            //console.log('color..'+color+'..size..'+size)
           // console.log(color)
        })
       console.log(arr);
    }
    function checkno(obj)
    {
        var no=$(obj).val()
        console.log(no)
        $.post("{:U('/Admin/Order/checkno')}",{no:no},function(data){
            if(data=='repeat'){
                layer.msg('已经有该款号请勿重复添加');
            // }else{
            //     layer.msg('删除失败,请重试');
            }
        })
    }
    function addtotal()
    {
        var alltotal=parseFloat($('[name="order_fmoney"]').val())+parseFloat($('[name="order_mfmoney"]').val())
        $('[name="order_allmoney"]').val(alltotal);
        //console.log(alltotal);
    }
    function checkall()
    {
        $('#check').empty();
        $('.copy').each(function(k,v){
            color=$.trim($(v).find($('select[name="order_color[]"]')).find('option:selected').text());
            size=$(v).find($('select[name="order_size[]"]')).find('option:selected').text();
            num=$(v).find($('input[name="order_total[]"]')).val();
            var str='</br>颜色:'+color+'|尺码:'+size+'|裁数:'+num;
            $('#check').append(str)
        })

    }
    
    </script>
</body>
</html>